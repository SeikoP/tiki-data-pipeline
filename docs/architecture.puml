@startuml Tiki Data Pipeline Architecture
!theme plain
skinparam backgroundColor #FFFFFF
skinparam componentStyle rectangle

title Tiki Data Pipeline - ETL Architecture

package "External Source" {
  [Tiki.vn Website] as TIKI
}

package "Airflow Orchestration" {
  [Airflow Scheduler] as SCHEDULER
  [Airflow API Server\n:8080] as API
  [Airflow Worker] as WORKER
  [DAG Processor] as PROCESSOR
}

package "Storage Layer" {
  database "PostgreSQL\nMetadata + Data" as POSTGRES
  database "Redis\nCache + Broker" as REDIS
}

package "Extract Pipeline" {
  [Crawl Categories] as CRAWL_CAT
  [Crawl Products\nDynamic Task Mapping] as CRAWL_PROD
  [Crawl Details\nSelenium] as CRAWL_DETAIL
}

package "Transform Pipeline" {
  [Transform Products\nNormalize + Validate] as TRANSFORM
  [Compute Fields\nRevenue, Popularity] as COMPUTE
}

package "Load Pipeline" {
  [Load to Database\nPostgreSQL + JSON] as LOAD
}

package "Data Storage" {
  folder "Raw Data\nJSON Files" as RAW_JSON
  folder "Processed Data\nJSON Files" as PROCESSED_JSON
  database "Products Table" as DB_TABLE
}

package "Asset Tracking" {
  [tiki://products/raw] as ASSET_RAW
  [tiki://products/with_detail] as ASSET_DETAIL
  [tiki://products/transformed] as ASSET_TRANS
  [tiki://products/final] as ASSET_FINAL
}

package "Validation & Analytics" {
  [Validate Data] as VALIDATE
  [Aggregate & Notify] as AGGREGATE
}

' External connections
TIKI --> CRAWL_CAT : HTTP/HTTPS
TIKI --> CRAWL_PROD : HTTP/HTTPS
TIKI --> CRAWL_DETAIL : Selenium

' Airflow orchestration
SCHEDULER --> POSTGRES
SCHEDULER --> REDIS
API --> POSTGRES
WORKER --> REDIS
WORKER --> POSTGRES
PROCESSOR --> SCHEDULER

' Extract flow
SCHEDULER --> CRAWL_CAT
CRAWL_CAT --> CRAWL_PROD
CRAWL_PROD --> RAW_JSON
CRAWL_PROD --> ASSET_RAW
CRAWL_PROD --> CRAWL_DETAIL
CRAWL_DETAIL --> RAW_JSON
CRAWL_DETAIL --> ASSET_DETAIL

' Transform flow
ASSET_DETAIL ..> TRANSFORM : Asset Trigger
TRANSFORM --> COMPUTE
COMPUTE --> PROCESSED_JSON
COMPUTE --> ASSET_TRANS

' Load flow
ASSET_TRANS ..> LOAD : Asset Trigger
LOAD --> DB_TABLE
LOAD --> PROCESSED_JSON
LOAD --> ASSET_FINAL

' Validation
ASSET_FINAL ..> VALIDATE : Asset Trigger
VALIDATE --> AGGREGATE

' Cache
REDIS ..> CRAWL_DETAIL : Cache
REDIS ..> CRAWL_PROD : Cache

@enduml

