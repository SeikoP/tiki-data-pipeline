================================================================================
                  TIKI DATA PIPELINE - HIERARCHICAL STRUCTURE GUIDE
================================================================================

ğŸ“Š HIERARCHICAL STRUCTURE (Cáº¥u TrÃºc PhÃ¢n Cáº¥p)

â”Œâ”€ Level 0 (ROOT - 3 categories)
â”‚  â”œâ”€ 316: SÃ¡ch tiáº¿ng Viá»‡t
â”‚  â”œâ”€ 320: English Books
â”‚  â””â”€ 915: Thá»i trang nam
â”‚
â””â”€ Level 1 (SUB-CATEGORIES - 13 under category 316)
   â”œâ”€ 393: SÃ¡ch thiáº¿u nhi (parent_id: 316)
   â”œâ”€ 839: SÃ¡ch vÄƒn há»c (parent_id: 316)
   â”œâ”€ 846: SÃ¡ch kinh táº¿ (parent_id: 316)
   â”œâ”€ 870: SÃ¡ch ká»¹ nÄƒng sá»‘ng (parent_id: 316)
   â”œâ”€ 873: SÃ¡ch Kiáº¿n Thá»©c Tá»•ng Há»£p (parent_id: 316)
   â””â”€ ... 8 more
   
   â””â”€ Level 2 (SUB-SUB-CATEGORIES - 59 under various Level 1 categories)
      â”œâ”€ 852: Äáº¡o Ä‘á»©c - Ká»¹ nÄƒng sá»‘ng (parent_id: 393)
      â”œâ”€ 853: Kiáº¿n thá»©c - BÃ¡ch khoa (parent_id: 393)
      â”œâ”€ 854: Truyá»‡n ká»ƒ cho bÃ© (parent_id: 393)
      â”œâ”€ 855: Truyá»‡n tranh thiáº¿u nhi (parent_id: 393)
      â””â”€ ... 55 more


================================================================================
JSON STRUCTURE EXAMPLE
================================================================================

[
  {
    "name": "SÃ¡ch tiáº¿ng Viá»‡t",
    "url": "https://tiki.vn/sach-truyen-tieng-viet/c316",
    "category_id": "316",
    "slug": "c316",
    "parent_id": null,              â† ROOT: parent_id = null
    "parent_name": null,
    "parent_url": null,
    "sub_categories": [             â† Contains 13 sub-categories
      {
        "name": "SÃ¡ch thiáº¿u nhi",
        "url": "https://tiki.vn/sach-truyen-thieu-nhi/c393",
        "category_id": "393",
        "slug": "c393",
        "parent_id": "316",          â† MATCHES parent's category_id âœ…
        "parent_name": "SÃ¡ch tiáº¿ng Viá»‡t",
        "parent_url": "https://tiki.vn/sach-truyen-tieng-viet/c316",
        "level": 1,
        "sub_categories": [          â† Contains 11 sub-sub-categories
          {
            "name": "Äáº¡o Ä‘á»©c - Ká»¹ nÄƒng sá»‘ng",
            "url": "https://tiki.vn/bai-hoc-dao-duc/c852",
            "category_id": "852",
            "slug": "c852",
            "parent_id": "393",      â† MATCHES parent's category_id âœ…
            "parent_name": "SÃ¡ch thiáº¿u nhi",
            "parent_url": "https://tiki.vn/sach-truyen-thieu-nhi/c393",
            "level": 2,
            "sub_categories": []     â† No level 3 for this demo
          },
          {
            "name": "Kiáº¿n thá»©c - BÃ¡ch khoa",
            "category_id": "853",
            "parent_id": "393",      â† MATCHES parent's category_id âœ…
            ...
          }
        ]
      },
      {
        "name": "SÃ¡ch vÄƒn há»c",
        "category_id": "839",
        "parent_id": "316",          â† MATCHES parent's category_id âœ…
        ...
      }
    ]
  },
  {
    "name": "English Books",
    "category_id": "320",
    "parent_id": null,              â† ROOT: no parent
    "sub_categories": []            â† No sub-categories in this demo
  },
  {
    "name": "Thá»i trang nam",
    "category_id": "915",
    "parent_id": null,              â† ROOT: no parent
    "sub_categories": []            â† No sub-categories in this demo
  }
]


================================================================================
KEY RULES (Quy Táº¯c Quan Trá»ng)
================================================================================

âœ… CORRECT RULES:
   1. ROOT category: parent_id = null
   2. CHILD category: parent_id = parent's category_id
   3. Each category can have MULTIPLE sub_categories
   4. Each sub_category has exactly ONE parent
   5. No circular references (A â†’ B â†’ A)
   6. No duplicate category_id in entire tree
   7. parent_name matches parent's name
   8. parent_url matches parent's url

âŒ INVALID RULES (would fail validation):
   1. Child has parent_id â‰  parent's category_id
   2. Circular reference: A â†’ B â†’ A
   3. Duplicate category_id
   4. Self-reference: category_id = parent_id
   5. Missing parent: parent_id exists but parent not found


================================================================================
VALIDATION RESULTS (Current Status)
================================================================================

âœ… PASSED:
   - Valid: True
   - Completeness: 67/67 (100%) âœ…
   - Duplicates: 0 âœ…
   - Circular refs: 0 âœ…
   - Parent_ID matches: 100% âœ…
   - Missing categories: 0 âœ…
   - Errors: 0 âœ…

STATISTICS:
   - Root categories: 3
   - Total categories: 67 (across all levels)
   - Max depth: 3 levels
   - Level 0 (root): 3 categories
   - Level 1: 13 categories
   - Level 2: 59 categories


================================================================================
HOW TO READ THE JSON
================================================================================

To understand relationships:

1. TOP-LEVEL ARRAY contains ROOT categories
2. Each ROOT has "sub_categories" array
3. Each SUB-CATEGORY in that array has:
   - parent_id = the root's category_id
   - parent_name = the root's name
   - Its own "sub_categories" array (for next level)
4. Repeat recursively

Example traversal:
   root = array[0] â†’ "SÃ¡ch tiáº¿ng Viá»‡t" (id: 316)
   â”œâ”€ sub1 = root.sub_categories[0] â†’ "SÃ¡ch thiáº¿u nhi" (id: 393, parent: 316)
   â”œâ”€ sub2 = root.sub_categories[1] â†’ "SÃ¡ch vÄƒn há»c" (id: 839, parent: 316)
   â””â”€ sub1_sub = sub1.sub_categories[0] â†’ "Äáº¡o Ä‘á»©c - Ká»¹ nÄƒng sá»‘ng" (id: 852, parent: 393)


================================================================================
PERFORMANCE CHARACTERISTICS
================================================================================

Reading/Traversing:
   - Random access: O(1) if you know category_id
   - Sequential access: O(n)
   - Finding parent: O(1) using parent_id
   - Depth-first traversal: O(n)

File size (demo):
   - 67 categories: ~60-80 KB

Scaling:
   - 1000 categories: ~1 MB
   - 10000 categories: ~10 MB
   - 100000 categories: ~100 MB

Max depth handling:
   - No hard limit
   - Algorithm works even with depth 50+
   - Validation limits recursion to max_depth=100 (safety)


================================================================================
UPDATING/MODIFYING
================================================================================

âŒ DON'T:
   - Manually edit parent_id without updating parent_name
   - Add circular references
   - Create duplicate category_id
   - Change structure without running validation

âœ… DO:
   - Use build_hierarchical_structure() to rebuild from flat list
   - Run validate_hierarchical_structure() after any changes
   - Keep parent_id, parent_name, parent_url in sync
   - Use provided scripts for bulk operations


================================================================================
TROUBLESHOOTING
================================================================================

Problem: Validation fails with "Duplicate category_id"
Solution: Run with newer data or check if same category appears in multiple levels

Problem: Parent not found
Solution: Run validation to see which parent is missing, reload data

Problem: Circular reference detected
Solution: This shouldn't happen with current algorithm, file may be corrupted

Problem: Structure looks wrong
Solution: 
   1. Run: python scripts/validate_hierarchical.py
   2. Check output for specific issues
   3. Rebuild from source data if needed


================================================================================
REFERENCES
================================================================================

- File Location: data/raw/demo/demo_hierarchical.json
- Validation Script: scripts/validate_hierarchical.py
- Validator Function: src/pipelines/crawl/tiki/extract_category_link.py
- Builder Function: src/pipelines/crawl/tiki/extract_category_link.py

Last Updated: 2025-11-10
Status: âœ… Structure Verified and Validated
================================================================================

